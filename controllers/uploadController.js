var express    = require('express');
var bodyParser     = require("body-parser");
//MYSQL database config file
var db = require('../database/db_config.js').localConnect();
var multer          = require('multer');
var path = require('path');
var uuid = require('uuid');
var getColors = require("get-image-colors");
var ce = require('colour-extractor')
var logger = require('../logging/logger.js');   
var photoQuerys = [];
var serverResUrl ="https://res-1";
var serverCounter=1;
var numCPUs = require('os').cpus().length;


//var sharp       = require('sharp');
//sharp.concurrency(numCPUs);

var cloudinary  = require('cloudinary');
var autoRotate  = require('exif-image-auto-rotation');
var readChunk   = require('read-chunk');
var imageType   = require('image-type');
var getColors   = require("get-image-colors");
var ffmetadata  = require("ffmetadata");
var thumbler    = require('video-thumb');
var Exif        = require("simple-exiftool");


var fs = require('fs');
var imageUpload  = function (req, res, next) {
    var fs = require('fs');
    // string generated by canvas.toDataURL()
    var img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0"
        + "NAAAAKElEQVQ4jWNgYGD4Twzu6FhFFGYYNXDUwGFpIAk2E4dHDRw1cDgaCAASFOffhEIO"
        + "3gAAAABJRU5ErkJggg==";

    //var savePath = path.resolve(__dirname + '../../../tmp/'
      //  + Math.floor(Math.random() * 1000000) + '.png');
    // strip off the data: url prefix to get just the base64-encoded bytes
    var data = img.replace(/^data:image\/\w+;base64,/, "");
    var buf = new Buffer(data, 'base64');

    var savePath = path.resolve(__dirname + '../../../tmp/'
        + Math.floor(Math.random() * 1000000) + '.png');

    fs.writeFile(__dirname +'raj.png', buf, function(err){
       if (err){
           res.json("image uploaded failed");
           throw err;

       }
       res.json("image uploaded");
    });
};

function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min)) + min;
}

function checkEmpty(val){
    if(val === '' || val === null ||typeof val === 'undefined'){
        return false;
    }else{
        return true;
    }
}

var addImageFormPost = function(req, res, next){

};

fileUploadMutlerTestOld = function(req, res, next) {
        var myFile="";
        var FilesNames = [];
        var allFiles = {};

        var urlsString= req.hostname;
        urlsString= urlsString+":"+"3000/"+"static/";
        var folderName = (req.body.folderName)?req.body.folderName:'common';
        if (!fs.existsSync("uploads/" + folderName)) {
            fs.mkdirSync("uploads/" + folderName, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        var storage =   multer.diskStorage({
                destination: function (req, file, callback) {
                    callback(null, './uploads/'+folderName);
                },
                filename: function (req, file, callback) {
                                        myFile =""+ uuid.v1()+path.extname(file.originalname);
                                        FilesNames.push(urlsString+folderName+"/"+myFile);
                    callback(null, myFile);
                }
        });

        var upload = multer({ storage : storage }).array('userPhoto',10);
        upload(req,res,function(err) {
        if(err) {
            return res.end("Error uploading file.");
        }
        allFiles.filePaths = FilesNames;
        res.send(allFiles);
        });
};

fileUploadMutlerTest = function(req, res, next) {
        var myFile="";
        var FilesNames = [];
        var allFiles = {};


        var homeId = req.query.hId;
        var nabId = req.query.nId;
        var pType = req.query.pType;
        var coverPhotoType = req.query.coverPhotoType;
        var urlsString= req.hostname;
        var activeFlag = req.query.activeFlag;
        var storyId = req.query.storyId;
        var userid = req.query.userid;
        if(!checkEmpty(activeFlag) ){
           activeFlag =1;
        }
        urlsString= urlsString+":"+"3000/"+"static/";
        var folderName = (req.body.folderName)?req.body.folderName:'common';
        if (!fs.existsSync("uploads/" + folderName)) {
            fs.mkdirSync("uploads/" + folderName, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        var storage =   multer.diskStorage({
                        destination: function (req, file, callback) {
                                callback(null, './uploads/'+folderName);
                        },
                        filename: function (req, file, callback) {
                                myFile =""+ uuid.v1()+path.extname(file.originalname);
                                FilesNames.push(urlsString+folderName+"/"+myFile);
                                var dTime = new Date().getTime();
                                var photoId;
                                var rNum = getRandomInt(10,99);
                                var num = getRandomInt(10,99);
                                photoId = ''+rNum+''+dTime+''+num;

                                var photoPath= folderName+"/"+myFile ;
                                var sqlPhotos = "INSERT INTO tbl_photo_master SET ";
                                var sqlPhotoGen = "";

                                if(checkEmpty(photoId)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                    sqlPhotoGen += " photo_id = "+ photoId +"";
                                }

                                if(checkEmpty(nabId)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                    sqlPhotoGen += " hood_id = "+ nabId +"";
                                }
                                 if(checkEmpty(homeId)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                    sqlPhotoGen += " home_id = "+ homeId +"";
                                }
                                if(checkEmpty(coverPhotoType)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                    sqlPhotoGen += " cover_photo = "+ coverPhotoType +"";
                                }

                                if(checkEmpty(activeFlag)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                    sqlPhotoGen += " active_flag = "+ activeFlag +"";
                                }
                                if(checkEmpty(photoId)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                    sqlPhotoGen += "createdon = now()";
                                }
                                if(checkEmpty(storyId)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                   sqlPhotoGen += " story_id = "+ storyId +"";
                                }
                                 if(checkEmpty(pType)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                   sqlPhotoGen += " userid = "+ userid +"";
                                }
                                if(checkEmpty(pType)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                   sqlPhotoGen += " photo_type = "+ pType +"";
                                }
                                if(checkEmpty(photoPath)){
                                    if(sqlPhotoGen !== "")
                                    {
                                        sqlPhotoGen += ",";
                                    }
                                   sqlPhotoGen += " photo_path = '"+ photoPath +"'";
                                }

                                sqlPhotos = sqlPhotos +" " +sqlPhotoGen+" ON DUPLICATE KEY UPDATE "+ sqlPhotoGen+" ";
                                db.query(sqlPhotos, function (err, result) {

                                  if (err) {
                                      throw err;
                                  }
                                });
                                callback(null, myFile);
                        }
        });
        var upload = multer({ storage : storage }).array('userPhoto',10);



        upload(req,res,function(err) {
        if(err) {
            return res.end("Error uploading file.");
        }
        allFiles.filePaths = FilesNames;
        res.send(allFiles);
        });

};
/**
 * @api {post} /home/:id Upload Photo to Timeline
 * @apiName timelinePhotoUpload
 * @apiGroup Photo
 *
 * @apiParam {Number} id Photo's unique ID.
 *
 * @apiSuccess {String} firstname Firstname of the User.
 * @apiSuccess {String} lastname  Lastname of the User.
 *
 * @apiSuccessExample Success-Response:
 *     HTTP/1.1 200 OK
 *     {
 *       "success": "Posted successfully",
 *       "lastname": "Doe"
 *     }
 *
 * @apiError PhotoNotUploaded The id of the User was not found.
 *
 * @apiErrorExample Error-Response:
 *     HTTP/1.1 404 Not Found
 *     {
 *       "error": "Photo was not uploaded"
 *     }
 */

timelinePhotoUpload = function(req, res, next) {

      var myFile="";
      var FilesNames = [];
      var results = {};
      var photoArray = [];
      var allFiles = {};
      var homeId = req.query.hId;
      var nabId = req.query.nId;
      var pType = req.query.pType;
      var coverPhotoType = (checkEmpty(req.query.pType) ? req.query.pType : req.query.coverPhotoType);
      var urlsString= req.hostname;
      var activeFlag = req.query.activeFlag;
      var storyId = req.query.storyId;
      var userid = req.query.userid;
      var timelineids = req.query.timelineids;
      if(!checkEmpty(activeFlag) ){
         activeFlag =1;
      }
      urlsString= urlsString+":"+"3000/"+"static/";
      var folderName = (req.body.folderName)?req.body.folderName:'common';
      if (!fs.existsSync("uploads/" + folderName)) {
          fs.mkdirSync("uploads/" + folderName, 0777, function (err,callback) {
              if (err) {
                  callback('folder created');
              }
          });
      }

      var storage =   multer.diskStorage({
          destination: function (req, file, callback) {
                  callback(null, './uploads/'+folderName);
          },
          filename: function (req, file, callback) {
              myFile =""+ uuid.v1()+path.extname(file.originalname);
              var fileDetails = {};
              FilesNames.push(urlsString+folderName+"/"+myFile);

              var photoPath= folderName+"/"+myFile ;
              if(timelineids)
              {
                  var tids = timelineids.split(',');
                  tids.forEach( function(vk, i) {

                      var dTime = new Date().getTime();
                      var photoId;
                      var rNum = getRandomInt(1,9);
                      photoId = ''+rNum+''+dTime;

                      fileDetails.photId = photoId;
                      fileDetails.filePath = (urlsString+folderName+"/"+myFile);
                      photoArray.push(fileDetails);

                      var sqlPhotos = "INSERT INTO tbl_photo_master SET ";
                      var sqlPhotoGen = "";

                      if(checkEmpty(photoId)){
                          if(sqlPhotoGen !== "")
                          {
                              sqlPhotoGen += ",";
                          }
                          sqlPhotoGen += " photo_id = "+ photoId +"";
                      }

                      if(checkEmpty(vk)){
                          if(sqlPhotoGen !== "")
                          {
                              sqlPhotoGen += ",";
                          }
                         sqlPhotoGen += " timeline_id = '"+ vk +"'";
                      }

                      if(checkEmpty(photoPath)){
                          if(sqlPhotoGen !== "")
                          {
                              sqlPhotoGen += ",";
                          }
                         sqlPhotoGen += " photo_path = '"+ photoPath +"'";
                      }

                      sqlPhotos = sqlPhotos +" " +sqlPhotoGen+" ON DUPLICATE KEY UPDATE "+ sqlPhotoGen+" ";
                      db.query(sqlPhotos, function (err, result) {

                        if (err) {
                            throw err;
                        }
                      });
                      callback(null, myFile);
                  });
              }
          }
      });
      var upload = multer({ storage : storage }).array('userPhoto',10);
      upload(req,res,function(err) {
      if(err) {
          return res.end("Error uploading file.");
      }
      allFiles.filePaths = FilesNames;
      allFiles.details =  photoArray;
      res.send(allFiles);
      });
};

photosUpload2 = function(req, res, next) {
  /*const*/  var  getColors = require("get-image-colors");

        var myFile="";
        var FilesNames = [];
        var results = {};
        var photoArray = [];
        var allFiles = {};
        var homeId = req.query.hId;
        var nabId = req.query.nId;
        var pType = req.query.pType;
        var coverPhotoType = (checkEmpty(pType) ? pType : req.query.coverPhotoType);
        var urlsString= req.hostname;
        var activeFlag = req.query.activeFlag;
        var storyId = req.query.storyId;
        var userid = req.query.userid;
        var timelineids = req.query.timelineids;
        if(!checkEmpty(activeFlag) ){
           activeFlag =1;
        }
        urlsString= urlsString+":"+"3000/"+"static/";
        var folderName = (req.body.folderName)?req.body.folderName:'common';
        if (!fs.existsSync("uploads/" + folderName)) {
            fs.mkdirSync("uploads/" + folderName, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        var storage =   multer.diskStorage({
                        destination: function (req, file, callback) {
                                callback(null, './uploads/'+folderName);
                        },
                        filename: function (req, file, callback) {
                                myFile =""+ uuid.v1()+path.extname(file.originalname);
                                var fileDetails = {};
                                FilesNames.push(urlsString+folderName+"/"+myFile);
                                var dTime = new Date().getTime();
                                var rNum = getRandomInt(1,9);
                                var num = getRandomInt(1,9);
                                var photoId = ''+rNum+''+dTime+''+num;
                                fileDetails.filePath = (urlsString+folderName+"/"+myFile);
                                fileDetails.photId = photoId;
                                photoArray.push(fileDetails);
                                var photoPath= folderName+"/"+myFile ;
                                var sqlPhotos = "INSERT INTO tbl_photo_master SET ";
                                var sqlPhotoGen = "";
                                if(checkEmpty(nabId)){
                                    sqlPhotoGen += " hood_id = "+ nabId +", ";
                                }
                                 if(checkEmpty(homeId)){
                                    sqlPhotoGen += " home_id = "+ homeId +", ";
                                }
                                if(checkEmpty(coverPhotoType)){
                                    sqlPhotoGen += " cover_photo = "+ coverPhotoType +", ";
                                }
                                if(checkEmpty(activeFlag)){
                                    sqlPhotoGen += " active_flag = "+ activeFlag +", ";
                                }
                                if(checkEmpty(storyId)){
                                   sqlPhotoGen += " story_id = "+ storyId +", ";
                                }
                                 if(checkEmpty(userid)){
                                   sqlPhotoGen += " userid = "+ userid +", ";
                                }
                                if(checkEmpty(pType)){
                                   sqlPhotoGen += " photo_type = "+ pType +", ";
                                }
                                if(checkEmpty(photoPath)){
                                   sqlPhotoGen += " photo_path = '"+ photoPath +"', ";
                                }
                                if(checkEmpty(photoId)){
                                    sqlPhotoGen += "createdon = now() ";
                                }

                                sqlPhotos = sqlPhotos +" " +sqlPhotoGen+"ON DUPLICATE KEY UPDATE "+ sqlPhotoGen+" ";
                                db.query(sqlPhotos, function (err, result) {

                                  if (err) {
                                      throw err;
                                  }
                                });
                                callback(null, myFile);
                        }
        });
        var upload = multer({ storage : storage }).array('userPhoto',20);

        upload(req,res,function(err) {

        if(err) {
            return res.end("Error uploading file.");
        }

        allFiles.filePaths = FilesNames;
        allFiles.details =  photoArray;
        res.send(allFiles);
    });

};

updateHex = function(colorCode, id) {

    var sQuery = "UPDATE \n\
                      tbl_photo_master \n\
                  SET \n\
                      color_codes = '" + colorCode + "' \n\
                  WHERE \n\
                      photo_id = "+ id;
    db.query(sQuery, function (err, result) {
        if (err) {
            throw err;
        }
    });
};

componentToHex = function(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
};

rgbToHex = function(arr) {
    return "#" + componentToHex(parseInt(arr[0])) + componentToHex(parseInt(arr[1])) + componentToHex(parseInt(arr[2]));
}

var fetchCloudLink = function(req, res, next) {
    var pid = req.query.pid;

    var sql = "SELECT cloud_path, photo_id, cover_photo from tbl_photo_master where photo_id in ("+pid+")";

    db.query(sql, function (err, rows) {
        if(rows)
        {
            var retArr = [];
            rows.forEach( function(vl, i) {

                var data = {};
                data.url = (vl.cloud_path ? vl.cloud_path : '');
                data.pid = (vl.cloud_path ? vl.photo_id : '');
                data.ptype = (vl.cover_photo ? vl.cover_photo : '');
                retArr.push(data);
            });
            res.json(retArr);
        }
    });
};

var moveVideosToCloud = function(req, res, next) {

    var imgDirq = "" + __dirname;
    var imgDirqArr = imgDirq.split('/');
    imgDirq = imgDirqArr.splice((imgDirqArr.length-1), 1);

    if(req.hostname === 'localhost') {
        var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
        var urlsString = imgDirq+'uploads/';
    }
    else {
        var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
        var urlsString = imgDirq+'uploads/';
    }

    var tt = 0;
    var data = {};

    var cloudinary = require('cloudinary');
    cloudinary.config({
        cloud_name: 'homehapp',
        api_key: '674338823352987',
        api_secret: 'urOckACznNPsN58_1zewwJmasnI'
    });

    var sql = "SELECT \n\
                  photo_id, \n\
                  photo_path, \n\
                  cover_photo \n\
              FROM \n\
                  tbl_photo_master \n\
              WHERE \n\
                  (cloud_path is NULL or cloud_path = '') \n\
              AND \n\
                  cover_photo = 8 \n\
              ORDER BY \n\
                  createdon DESC";
    db.query(sql, function (err, rows) {
        
        rows.forEach( function(vl, i) {
            
            var photoPath = urlsString+vl.photo_path;
            cloudinary.uploader.upload_large(photoPath,
            function(result) {
                if(result.url) {
                    var cloudURL = result.url;
                    if(serverCounter ==6){
                        serverCounter =1;
                    }
                    if(cloudURL.match('^http://')){
                        serverResUrl = "https://res-"+serverCounter;
                        cloudURL = cloudURL.replace("http://res",serverResUrl);
                    } 
                    var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = "+result.width+", height = "+result.height+" WHERE photo_id = "+vl.photo_id;
                    serverCounter= serverCounter+1;
                    db.query(upsql, function (err, req) {
                        if(req)
                        {
                            if(tt == (rows.length - 1))
                            {
                                data.msg = 'Images moved to cloud';
                                res.json(data);
                            }
                            tt++;
                        }
                    });
                }
            },
            {
                resource_type: "video",
                chunk_size: 6000000,
                timeout: 100000000000
            });
        });
    });
};

var deleteFromCloud = function(req, res, next) {
    var cloudinary = require('cloudinary');
    cloudinary.config({
        cloud_name: 'homehapp',
        api_key: '674338823352987',
        api_secret: 'urOckACznNPsN58_1zewwJmasnI'
    });
    var sql = "SELECT \n\
                  photo_id as pid, \n\
                  photo_path, \n\
                  cover_photo, \n\
                  cloud_path \n\
              FROM \n\
                  tbl_photo_master \n\
              WHERE \n\
                  cloud_path is not null \n\
              ORDER BY \n\
                  createdon DESC limit 1000";
    db.query(sql, function (err, rows) {

        var tt = 0;
        var data = {};
        rows.forEach( function(vl, i) {

            if(vl.cloud_path) {
                var imgPath = vl.cloud_path.split('/');
                var pth = imgPath[imgPath.length-1];
                var idArr = pth.split('.');
                var delid = idArr[0];

                cloudinary.uploader.destroy(delid, function(result) {

                    var upsql = "UPDATE tbl_photo_master SET cloud_path = null WHERE photo_id = "+vl.pid;

                    db.query(upsql, function (err, req) {

                    });
                    if(tt == (rows.length - 1))
                    {
                        data.msg = 'Images deleted from cloud';
                        res.json(data);
                    }
                    tt++;
                },
                {
                    timeout: 100000000000
                });
            }

        });
    });
};

var moveToCloud = function(req, res, next) {

    var urlsString = 'http://' + req.hostname;
    if (req.hostname === 'localhost') {
        urlsString = urlsString + '/homehapp';
    }
    urlsString += '/uploads/';

    var tt = 0;
    var data = {};

    var cloudinary = require('cloudinary');
    cloudinary.config({
        cloud_name: 'homehapp',
        api_key: '674338823352987',
        api_secret: 'urOckACznNPsN58_1zewwJmasnI'
    });

    var sql = "SELECT \n\
                  photo_id, \n\
                  photo_path, \n\
                  cover_photo \n\
              FROM \n\
                  tbl_photo_master \n\
              WHERE \n\
                  cover_photo <> 8 \n\
              AND \n\
                  (cloud_path is NULL or cloud_path = '') \n\
              ORDER BY \n\
                  createdon DESC";
    db.query(sql, function (err, rows) {

        rows.forEach( function(vl, i) {
            if(vl.photo_path)
            {
                var ppth = vl.photo_path.split('.');
                ppth[ppth.length-2] = ppth[ppth.length-2]+'_optimized';
                vl.photo_path = ppth.join('.');

                var photoPath = urlsString+vl.photo_path;
                
                cloudinary.uploader.upload(photoPath, function(result) {

                    if(result.url)
                    {
                        var cloudURL = result.url;
                        if(serverCounter ==6){
                            serverCounter =1;
                        }
                        if(cloudURL.match('^http://')){
                            serverResUrl = "https://res-"+serverCounter;
                            cloudURL = cloudURL.replace("http://res",serverResUrl);
                        } 
                        var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = "+result.width+", height = "+result.height+" WHERE photo_id = "+vl.photo_id;
                        serverCounter= serverCounter+1;
                        db.query(upsql, function (err, req) {
                            if(req)
                            {
                                if(tt == (rows.length - 1))
                                {
                                    data.msg = 'Images moved to cloud';
                                    res.json(data);
                                }
                                tt++;
                            }
                        });
                    }
                    else {
                        if(tt == (rows.length - 1))
                        {
                            data.msg = 'Images moved to cloud';
                            res.json(data);
                        }
                        tt++;
                    }
                },
                {
                    timeout: 100000000000
                });
            }
        });
    });
}

var uploadVideoQueuePush = function(req, res, next) {
    logger.info("IN QUEUE PUSH");
    logger.info(req.body);
    var dt = JSON.parse(req.body.dt);

    var promArr = [];
    var tt = dt.length;
    var prom = new Promise(function(resolve, reject) {
        dt.forEach(function(vl, i) {
            promArr.push(uploadVideoQueuePromise(vl.pid, vl.videoUrl, vl.photo_type, vl.hexCode, req.hostname));
            tt--;
            if(tt==0) {
                resolve(promArr);
            }
        });
    });

    prom.then(function(promArr) {
        Promise.all(promArr).then(values => {
            res.json(values);
        }, reason => {

        });
    })
};

var uploadVideoQueuePromise = function(pid, videoUrl, photo_type, hexCode, hostname) {

    var prom = new Promise(function(resolve, reject) {

        var imgDirq = "" + __dirname;

        if(hostname === 'localhost') {
            var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
            var urlsString = imgDirq+'uploads/';
        }
        else {
            var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
            var urlsString = imgDirq+'uploads/';
        }

        var cloudinary = require('cloudinary');
        cloudinary.config({
            cloud_name: 'homehapp',
            api_key: '674338823352987',
            api_secret: 'urOckACznNPsN58_1zewwJmasnI'
        });

        var photoPath = urlsString+videoUrl;

        if(photo_type == 8)
        {
            
            cloudinary.uploader.upload_large(photoPath,
            function(result) {
                
                var cloudURL = result.url;
                if(serverCounter ==6){
                    serverCounter =1;
                }
                if(cloudURL.match('^http://')){
                    serverResUrl = "https://res-"+serverCounter;
                    cloudURL = cloudURL.replace("http://res",serverResUrl);
                } 
                var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", height = "+result.height+", width = "+result.width+", color_codes = \""+hexCode+"\" WHERE photo_id = "+pid;
                serverCounter= serverCounter+1;
                db.query(upsql, function (err, req) {
                    if(req)
                    {
                        var data    = {};
                        data.url    = cloudURL;
                        data.pid    = pid;
                        data.ptype  = photo_type;
                        resolve(data);
                    }
                });
            },
            {
                resource_type: "video",
                timeout: 100000000000,
                chunk_size: 6000000
            });
        }
        else {

            var fileName = photoPath.split('.');
            fileName[fileName.length-2] = fileName[fileName.length-2]+'_optimized';
            var vk = fileName.join('.');
            
            cloudinary.uploader.upload(vk, function(result) {
                var cloudURL = result.url;
                if(serverCounter == 6){
                    serverCounter = 1;
                }
                if(cloudURL.match('^http://')){
                    serverResUrl = "https://res-"+serverCounter;
                    cloudURL = cloudURL.replace("http://res",serverResUrl);
                } 
                var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", height = "+result.height+", width = "+result.width+", color_codes = \""+hexCode+"\" WHERE photo_id = "+pid;
                serverCounter= serverCounter+1;
                db.query(upsql, function (err, req) {
                    if(req)
                    {
                        var data    = {};
                        data.url    = cloudURL;
                        data.pid    = pid;
                        data.ptype  = photo_type;
                        resolve(data);
                    }
                });
            },
            {
                timeout: 100000000000
            });
        }

    });
    return prom;
}

var uploadVideoQueue = function (req, res, next) {

    var url = req.body.videoUrl;
    var pid = req.body.pid;
    var ptype = req.body.photo_type;
    var color_codes = req.body.hexCode;

    var imgDirq = "" + __dirname;

    if(req.hostname === 'localhost') {
        var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
        var urlsString = imgDirq+'uploads/';
    }
    else {
        var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
        var urlsString = imgDirq+'uploads/';
    }

    var cloudinary = require('cloudinary');
    cloudinary.config({
        cloud_name: 'homehapp',
        api_key: '674338823352987',
        api_secret: 'urOckACznNPsN58_1zewwJmasnI'
    });

    photoPath = urlsString+url;

    if(ptype == 8)
    {   
        cloudinary.uploader.upload_large(photoPath,
        function(result) {

            var cloudURL = result.url;
            if(serverCounter ==6){
                serverCounter =1;
            }
            if(cloudURL.match('^http://')){
                serverResUrl = "https://res-"+serverCounter;
                cloudURL = cloudURL.replace("http://res",serverResUrl);
            } 
            var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", height = "+result.height+", width = "+result.width+", color_codes = \""+color_codes+"\" WHERE photo_id = "+pid;
            serverCounter= serverCounter+1;
            db.query(upsql, function (err, req) {
                if(req)
                {
                    var data    = {};
                    data.url    = cloudURL;
                    data.pid    = pid;
                    data.ptype  = ptype;
                    res.json(data);
                }
            });
        },
        {
            resource_type: "video",
            timeout: 100000000000,
            chunk_size: 6000000
        });
    }
    else {
        
        var fileName = photoPath.split('.');
        fileName[fileName.length-2] = fileName[fileName.length-2]+'_optimized';
        var vk = fileName.join('.');
        
        cloudinary.uploader.upload(vk, function(result) {
            var cloudURL = result.url;
            if(serverCounter ==6){
                serverCounter =1;
            }
            if(cloudURL.match('^http://')){
                serverResUrl = "https://res-"+serverCounter;
                cloudURL = cloudURL.replace("http://res",serverResUrl);
            } 
            var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = "+result.width+", height = "+result.height+", color_codes = \""+color_codes+"\" WHERE photo_id = "+pid;
            serverCounter= serverCounter+1;
            db.query(upsql, function (err, req) {
                if(req)
                {
                    var data    = {};
                    data.url    = cloudURL;
                    data.pid    = pid;
                    data.ptype  = ptype;
                    res.json(data);
                }
            });
        },
        {
            timeout: 100000000000
        });
    }
};

var uploadVideoToCloud = function (url, req, pid) {

    var imgDirq = "" + __dirname;

    if(req.hostname === 'localhost') {
        var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
        var urlsString = imgDirq+'uploads/';
    }
    else {
        var imgDirq = "" + __dirname.replace(__dirname.split(path.sep).pop(),'');
        var urlsString = imgDirq+'uploads/';
    }

    var cloudinary = require('cloudinary');
    cloudinary.config({
        cloud_name: 'homehapp',
        api_key: '674338823352987',
        api_secret: 'urOckACznNPsN58_1zewwJmasnI'
    });

    photoPath = urlsString+url;
    
    cloudinary.uploader.upload_large(photoPath,
    function(result) {

        var cloudURL = result.url;
        if(serverCounter ==6){
            serverCounter =1;
        }
        if(cloudURL.match('^http://')){
            serverResUrl = "https://res-"+serverCounter;
            cloudURL = cloudURL.replace("http://res",serverResUrl);
        } 
        var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = "+result.width+", height = "+result.height+" WHERE photo_id = "+pid;
        serverCounter= serverCounter+1;
        db.query(upsql, function (err, req) {
            if(req)
            {

            }
        });
    },
    {
        resource_type: "video",
        timeout: 100000000000,
        chunk_size: 6000000
    });
};

var photosUploadNew = function(req, res, next) {

        cloudinary.config({
            cloud_name: 'homehapp',
            api_key: '674338823352987',
            api_secret: 'urOckACznNPsN58_1zewwJmasnI'
        });

        var myFile="";
        var FilesNames = [];
        var pushFileNames = [];
        var fileCompressPath = [];
        var colorImages= [];
        var results = {};
        var photoArray = [];
        var homeId = req.query.hId;
        var nabId = req.query.nId;
        var pType = req.query.pType;
        var coverPhotoType = (checkEmpty(pType) ? pType : req.query.coverPhotoType);
        var coverPhotoTypeModified = (checkEmpty(pType) ? pType : req.query.coverPhotoType);
        var activeFlag = req.query.activeFlag;
        var storyId = req.query.storyId;
        var userid = req.query.userid;
        var timelineids = req.query.timelineids;
        if(!checkEmpty(activeFlag) ){
           activeFlag =1;
        }

        var forStory = (req.query.forStory ? req.query.forStory : 0);

        var urlsString = req.hostname;
        if (req.hostname === 'localhost') {
            urlsString = urlsString + '/homehapp';
        }
        urlsString += '/uploads/';

        var folderName = (req.body.folderName)?req.body.folderName:'common';
        if (!fs.existsSync("uploads/" + folderName)) {
            fs.mkdirSync("uploads/" + folderName, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        var d   = new Date();
        var yy  = d.getFullYear();
        var mm  = d.getMonth()+1;
        var dd  = d.getDate();
        var h   = d.getHours();
        var m   = d.getMinutes();
        var uploadedFolder = "";

        var folderName = (req.body.folderName)?req.body.folderName:'common';
        uploadedFolder = folderName;

        if (!fs.existsSync("uploads/" + uploadedFolder)) {
            fs.mkdirSync(uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        uploadedFolder  += "/"+yy;
        if (!fs.existsSync("uploads/" +uploadedFolder)) {
            fs.mkdirSync("uploads/" +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+mm;
        if (!fs.existsSync("uploads/" + uploadedFolder)) {
            fs.mkdirSync("uploads/" +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+dd;
        if (!fs.existsSync("uploads/"  +uploadedFolder)) {
            fs.mkdirSync("uploads/"  +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+h;
        if (!fs.existsSync("uploads/"  +uploadedFolder)) {
            fs.mkdirSync("uploads/"  +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        var randomFilePath =""+ uuid.v1();
        var randomFolderName = randomFilePath.split("-").pop();
        uploadedFolder  += "/"+randomFolderName;
        if (!fs.existsSync("uploads/"  +uploadedFolder)) {
            fs.mkdirSync("uploads/"  +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        var storage =   multer.diskStorage({
                        destination: function (req, file, callback) {
                            callback(null, './uploads/'+uploadedFolder);
                        },
                        filename: function (req, file, callback) {

                                if(file.mimetype.indexOf('video') !== -1) {
                                    coverPhotoType = 8;
                                }
                                else {
                                    coverPhotoType = parseInt(coverPhotoTypeModified);
                                }

                                var imgData = {};

                                myFile =""+ uuid.v1()+path.extname(file.originalname);
                                var fileDetails = {};
                                FilesNames.push(urlsString+uploadedFolder+"/"+myFile);

                                var dTime = new Date().getTime();
                                var photoId;
                                var rNum = getRandomInt(1,9);
                                var num = getRandomInt(1,9);
                                photoId = ''+rNum+''+dTime+''+num;

                                var imgDirq = "" + __dirname;
                                var imgDir = "" + __dirname.split(path.sep).pop();
                                var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                var mainDir = imgDirq.replace(imgDir,'')+'uploads/';

                                var actualImagePath = withoutLastChunk+""+folderName+""+myFile;
                                fileDetails.filePath = (urlsString+uploadedFolder+"/"+myFile);
                                fileDetails.photId = photoId;
                                fileDetails.actualPath = actualImagePath;

                                imgData.name = myFile;
                                imgData.id = photoId;
                                imgData.ptype = coverPhotoType;
                                imgData.apath = mainDir+uploadedFolder;
                                imgData.oname = file.originalname;
                                fileCompressPath.push(imgData);

                                photoArray.push(fileDetails);
                                var photoPath= uploadedFolder+"/"+myFile ;

                                var sqlPhotos = "INSERT INTO tbl_photo_master SET ";
                                var sqlPhotoGen = "";
                                var sqlMultiplePhotoQuery = " ( ";
                                if(checkEmpty(photoId)){
                                    sqlMultiplePhotoQuery += " "+ photoId +", ";
                                }else{
                                     sqlMultiplePhotoQuery += " "+ photoId +", ";
                                }

                                if(checkEmpty(nabId)){
                                     sqlMultiplePhotoQuery += " "+ nabId +", ";
                                }else{
                                     sqlMultiplePhotoQuery += " NULL , ";
                                }
                                 if(checkEmpty(homeId)){
                                    sqlMultiplePhotoQuery += " "+ homeId +", ";
                                }else{
                                    sqlMultiplePhotoQuery += " NULL , ";
                                }
                                if(checkEmpty(coverPhotoType)){
                                    if(isNaN(coverPhotoType)){
                                        coverPhotoType = 5;
                                    }
                                    sqlMultiplePhotoQuery += " "+ coverPhotoType +", ";
                                }else{
                                     sqlMultiplePhotoQuery += " NULL , ";
                                }

                                if(checkEmpty(activeFlag)){
                                    sqlMultiplePhotoQuery += " "+ activeFlag +", ";
                                }else{
                                    sqlMultiplePhotoQuery += " 1 , ";
                                }
                                if(checkEmpty(photoId)){
                                    sqlMultiplePhotoQuery += " now() , ";
                                }else{
                                    sqlMultiplePhotoQuery += " now() , ";
                                }
                                if(checkEmpty(storyId)){
                                    sqlMultiplePhotoQuery += " "+ storyId +" , ";
                                }else{
                                    sqlMultiplePhotoQuery += " NULL , ";
                                }
                                 if(checkEmpty(userid)){
                                    sqlMultiplePhotoQuery += " "+ userid +" , ";
                                }else{
                                    sqlMultiplePhotoQuery += " NULL , ";
                                }
                                if(checkEmpty(pType)){
                                    sqlMultiplePhotoQuery += " "+ pType +" , ";
                                }else{
                                    sqlMultiplePhotoQuery += " NULL , ";
                                }
                                if(checkEmpty(photoPath)){
                                    sqlMultiplePhotoQuery += " '"+ photoPath +"' , ";
                                }else{
                                    sqlMultiplePhotoQuery += " NULL , ";
                                }
                                 if(checkEmpty(timelineids)){
                                    sqlMultiplePhotoQuery += " "+ timelineids +" ) ";
                                }else{
                                    sqlMultiplePhotoQuery += " NULL ) ";
                                }
                                photoQuerys.push(sqlMultiplePhotoQuery);

                                    if(checkEmpty(storyId)) {
                                        if(coverPhotoType == 1 ||  coverPhotoType === '1' || forStory == 1 || forStory === '1') {
                                            var sqlStory = "INSERT INTO tbl_story_master SET story_id = "+ storyId +" ON DUPLICATE KEY UPDATE story_id = "+ storyId +"";
                                            db.query(sqlStory, function (err, result) {

                                                  if (err) {
                                                        throw err;
                                                  }
                                            });
                                        }
                                    }
                                    if(checkEmpty(userid)) {
                                        if(coverPhotoType == 6 ||  coverPhotoType === '6'){
                                            var sQuery = 'UPDATE \n\
                                                                tbl_photo_master \n\
                                                            SET \n\
                                                                active_flag = 0 \n\
                                                            WHERE \n\
                                                                userid = ' + userid + '\n\
                                                            AND \n\
                                                                cover_photo = 6 \n\
                                                            AND \n\
                                                                photo_id <> "' + photoId + '"';
                                            db.query(sQuery, function(err, rows, fields) {
                                                   if(err){
                                                   }
                                            });
                                        }
                                    }

                                    if(checkEmpty(homeId)) {
                                        if(coverPhotoType == 1 ||  coverPhotoType === '1'){
                                            var sQuery = 'UPDATE \n\
                                                                tbl_photo_master \n\
                                                            SET \n\
                                                                active_flag = 0 \n\
                                                            WHERE \n\
                                                                home_id = ' + homeId + '\n\
                                                            AND \n\
                                                                cover_photo = 1 \n\
                                                            AND \n\
                                                                photo_id <> "' + photoId + '"';
                                            db.query(sQuery, function(err, rows, fields) {
                                                   if(err){
                                                   }
                                            });
                                        }
                                    }

                                    if(checkEmpty(storyId)) {
                                        if(coverPhotoType == 1 ||  coverPhotoType === '1') {
                                            var sQuery = 'UPDATE \n\
                                                                tbl_photo_master \n\
                                                            SET \n\
                                                                active_flag = 0 \n\
                                                            WHERE \n\
                                                                story_id = ' + storyId + '\n\
                                                            AND \n\
                                                                cover_photo = 1 \n\
                                                            AND \n\
                                                                photo_id <> "' + photoId + '"';
                                            db.query(sQuery, function(err, rows, fields) {
                                                   if(err){
                                                   }
                                            });
                                        }
                                    }
//                            });
                                callback(null, myFile);
                        }

        });
        var maxSize = 1000*1000*1000*1000;
        var upload = multer({ storage : storage, limits: { fileSize: maxSize } }).array('userPhoto',200);

        upload(req,res,function(err) {

            if(err) {
                return res.end("Error uploading file.");
            }
              var multipleInsert= " INSERT IGNORE INTO tbl_photo_master \n\
                                    ( \n\
                                        photo_id ,\n\
                                        hood_id ,\n\
                                        home_id, \n\
                                        cover_photo, \n\
                                        active_flag ,\n\
                                        createdon ,\n\
                                        story_id ,\n\
                                        userid ,\n\
                                        photo_type ,\n\
                                        photo_path ,\n\
                                        timeline_id \n\
                                    ) VALUES ";
            multipleInsert += photoQuerys.toString();

            db.query(multipleInsert, function (err, result) {
                if (err) {
                    throw err;
                }
                else {

                    var allimgs = fileCompressPath.length;

                    var promArr = [];
                    var promColor = [];

                    var p = new Promise(function(resolve, reject) {

                        fileCompressPath.forEach(function(vl, i) {

                            promArr.push(getUploadData(req, res, vl, uploadedFolder, urlsString, folderName));
                            promColor.push(getImageColors('uploads/'+uploadedFolder+'/'+vl.name, vl.id, vl.ptype));

                            allimgs--;
                            if(allimgs == 0) {
                                resolve(promArr);
                            }
                        });
                    });

                    p.then(function(promArr) {
                        Promise.all(promArr).then(values => {
                            var al = values.length;
                            var allfiles = {};
                            allfiles.filePaths = [];
                            allfiles.details = [];
                            values.forEach(function(vl,i) {
                                allfiles.filePaths.push(vl.filePaths);
                                allfiles.details.push(vl.details[0]);
                                al--;
                                if(al == 0) {
                                    Promise.all(promColor).then(values => {
                                        var ac = values.length;
                                        var dt = [];
                                        values.forEach(function(vl,i) {
                                            allfiles.details.forEach(function(vz,z) {
                                                if(parseInt(vz.photId) == parseInt(vl.id))
                                                {
                                                    vz.hexCode = vl.color;
                                                    ac--;
                                                    if(ac == 0) {
                                                        res.json(allfiles);
                                                    }
                                                }
                                            });
                                        });
                                    });
                                }
                            });
                        }, reason => {
                            //console.log(reason)
                        });
                    });
                }
            });
        });


        // var p1 = new Promise((resolve, reject) => {
        // setTimeout(resolve, 1000, "one");
        // });
        // var p2 = new Promise((resolve, reject) => {
        // setTimeout(resolve, 2000, "two");
        // });
        // var p3 = new Promise((resolve, reject) => {
        // setTimeout(resolve, 3000, "three");
        // });
        // var p4 = new Promise((resolve, reject) => {
        // setTimeout(resolve, 5000, "four");
        // });
        // var p5 = new Promise((resolve, reject) => {
        // setTimeout(resolve, 10000, "four");
        // });
        //
        // Promise.all([p1, p2, p3, p4, p5]).then(values => {
        // console.log(values);
        // }, reason => {
        // console.log(reason)
        // });

        //From console:
        //"reject"

        //It's even possible to use .catch
        // Promise.all([p1, p2, p3, p4, p5]).then(values => {
        //   console.log(values);
        // }).catch(reason => {
        //   console.log(reason)
        // });
};

var getImageColors = function(fileName, id, ptype) {

    var prom = new Promise(function(resolve, reject) {
        if(ptype == 8)
        {
            var dt = {};
            dt.id = id;
            dt.color = '';
            resolve(dt);
        }
        else {
            ce.topColours(fileName, true, function (colours) {
                // console.log(colours);
                var hexcode = [];
                colours.forEach( function(vz, k) {
                    vz[1].push(vz[0]);
                    // console.log(vz[1]);
                    var hexdata = rgbToHex(vz[1]);
                    hexcode.push(hexdata);
                });

                hexcode = hexcode.slice(0, 5);
                var hexList = hexcode.join(',');

                var dt = {};
                dt.id = id;
                dt.color = hexList;
                resolve(dt);
            });
        }

        // getColors(fileName, function(err, colors){
        // var hexcode = [];
        //
        // console.log(colors);
        //
        // if(!err)
        // {
        //     colors.forEach( function(vz, k) {
        //         var hexdata = rgbToHex(vz._rgb);
        //         hexcode.push(hexdata);
        //     });
        //     var hexList = hexcode.join(',');
        //     console.log('getColors - ' + hexList);
        //     var dt = {};
        //     dt.id = id;
        //     dt.color = hexList;
        //     resolve(dt);
        // }
        // else {
        //     var dt = {};
        //     dt.id = id;
        //     dt.color = '';
        //     resolve(dt);
        // }
        // });
    });
    return prom;
};


var getUploadData = function(req, res, vl, uploadedFolder, urlsString, folderName) {

        var prom = new Promise(function(resolve, reject) {

        var tot = 0;

        var allFiles = {};
        var fNames = [];
        var pArray = [];

        if(vl.ptype == 8) {

            var fileDetails = {};
            fNames.push(urlsString+uploadedFolder+"/"+vl.name);
            var imgDirq = "" + __dirname;
            var imgDir = "" + __dirname.split(path.sep).pop();
            var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

            var name = vl.name.split('.');

            var fconvertedPath = (urlsString+uploadedFolder+"/"+vl.name);
            var actualImagePath = withoutLastChunk+""+folderName+""+vl.name;
            var brkname = vl.name.split('.');
            brkname.pop();

            var screenShotName = brkname.join('.') + '.png';


            Exif('uploads/'+uploadedFolder+'/'+vl.name, function(error, metadata) {

                if(metadata.Rotation == 90)
                {
                    var vht = metadata.ImageWidth;
                    var vwt = metadata.ImageHeight;
                }
                else {
                    var vht = metadata.ImageHeight;
                    var vwt = metadata.ImageWidth;
                }

                fileDetails.filePath = urlsString+uploadedFolder+"/"+vl.name;
                fileDetails.poster = urlsString+uploadedFolder+"/"+name[0]+'.png';
                fileDetails.photId = vl.id;
                fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                fileDetails.photo_type = vl.ptype;
                fileDetails.hexCode = '';
                fileDetails.cloudFilePath = '';
                fileDetails.imgWidth = vwt;
                fileDetails.imgHeight = vht;
                fileDetails.rotation = '';
                fileDetails.poster = '';
                fileDetails.oname = vl.oname;
                pArray.push(fileDetails);
                // if(tot == (fileCompressPath.length - 1))
                {
                    allFiles.filePaths = fNames;
                    allFiles.details =  pArray.reverse();
                    // return allFiles;
                    resolve(allFiles);
                }
                tot++;
            });
        }
        else {

            var buffer = readChunk.sync('uploads/'+uploadedFolder+'/'+vl.name, 0, 12);
            var imageBuff = imageType(buffer);

            vl.newName = vl.name;

            if(imageBuff) {
                if(imageBuff.ext) {
                    var ppth = vl.name.split('.');
                    var oImgExt = ppth[ppth.length-1];
                    ppth[ppth.length-1] = imageBuff.ext;
                    vl.newName = ppth.join('.');
                }
            }

            var fileName = vl.name.split('.');
            fileName[fileName.length-2] = fileName[fileName.length-2]+'_optimized';
            var vk = fileName.join('.');
            var output = 'uploads/'+uploadedFolder+'/'+vk;

            var autoRotateAllow = true;

            if(vl.newName.indexOf(".jpg") == -1 || vl.newName.indexOf(".JPG") == -1 || vl.newName.indexOf(".jpeg") == -1 || vl.newName.indexOf(".JPEG") == -1) {
                autoRotateAllow = false;
            }

            if(!autoRotateAllow) {

                var image = sharp('uploads/'+uploadedFolder+'/'+vl.name);
                image
                    .metadata()
                    .then(function(metadata) {

                        if(metadata.width>1920) {

                            var nw = 1920;
                            return image
                            .resize(nw)
                            .toFile(output, function(err, info) {

                                var fileDetails = {};
                                fNames.push(urlsString+uploadedFolder+"/"+vk);
                                var imgDirq = "" + __dirname;
                                var imgDir = "" + __dirname.split(path.sep).pop();
                                var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                fileDetails.photId = vl.id;
                                fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                                fileDetails.photo_type = vl.ptype;


                                // getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                // var hexcode = [];
                                //
                                // if(!err)
                                // {
                                //     colors.forEach( function(vz, k) {
                                //         var hexdata = rgbToHex(vz._rgb);
                                //         hexcode.push(hexdata);
                                //     });
                                //     var hexList = hexcode.join(',');
                                //     // updateHex(hexList, vl.id);
                                //     fileDetails.hexCode = hexList;
                                // }
                                // else
                                        fileDetails.hexCode = '';

                                    // console.log('uploads/'+uploadedFolder+'/'+vl.name);

                                    // Exif('uploads/'+uploadedFolder+'/'+vl.name, function(error, metadata) {

                                        fileDetails.cloudFilePath = '';
                                        fileDetails.imgWidth = info.width;
                                        fileDetails.imgHeight = info.height;
                                        fileDetails.rotation = '';
                                        fileDetails.poster = '';
                                        fileDetails.oname = vl.oname;
                                        pArray.push(fileDetails);

                                        // if(tot == (fileCompressPath.length - 1))
                                        {
                                            allFiles.filePaths = fNames;
                                            allFiles.details =  pArray.reverse();
                                            // res.json(allFiles);
                                            resolve(allFiles);
                                        }
                                        tot++;
                                    // });
                                // });
                            });
                        }
                        else {
                            return image
                            .resize(metadata.width)
                            .toFile(output, function(err, info) {

                                var fileDetails = {};
                                fNames.push(urlsString+uploadedFolder+"/"+vk);
                                var imgDirq = "" + __dirname;
                                var imgDir = "" + __dirname.split(path.sep).pop();
                                var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                fileDetails.photId = vl.id;
                                fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                                fileDetails.photo_type = vl.ptype;


                                // getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                // var hexcode = [];
                                //
                                // if(!err)
                                // {
                                //     colors.forEach( function(vz, k) {
                                //         var hexdata = rgbToHex(vz._rgb);
                                //         hexcode.push(hexdata);
                                //     });
                                //     var hexList = hexcode.join(',');
                                //     // updateHex(hexList, vl.id);
                                //     fileDetails.hexCode = hexList;
                                // }
                                // else
                                        fileDetails.hexCode = '';

                                    // Exif('uploads/'+uploadedFolder+'/'+vl.name, function(error, metadata) {

                                        fileDetails.cloudFilePath = '';
                                        fileDetails.imgWidth = info.width;
                                        fileDetails.imgHeight = info.height;
                                        fileDetails.rotation = '';
                                        fileDetails.poster = '';
                                        fileDetails.oname = vl.oname;
                                        pArray.push(fileDetails);

                                        // if(tot == (fileCompressPath.length - 1))
                                        {
                                            allFiles.filePaths = fNames;
                                            allFiles.details =  pArray.reverse();
                                            // res.json(allFiles);
                                            resolve(allFiles);
                                        }
                                        tot++;
                                    // })
                                // });
                            });
                        }
                    })
                    .then(function(data) {

                    });
            }
            else {
                autoRotate( 'uploads/'+uploadedFolder+'/'+vl.name, function() {

                    var image = sharp('uploads/'+uploadedFolder+'/'+vl.name);
                    image
                        .metadata()
                        .then(function(metadata) {
                            if(metadata.width>1920) {

                                var nw = 1920;
                                return image
                                .resize(nw)
                                .toFile(output, function(err, info) {

                                    var fileDetails = {};
                                    fNames.push(urlsString+uploadedFolder+"/"+vk);
                                    var imgDirq = "" + __dirname;
                                    var imgDir = "" + __dirname.split(path.sep).pop();
                                    var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                    var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                    fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                    fileDetails.photId = vl.id;
                                    fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                                    fileDetails.photo_type = vl.ptype;


                                    // getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors) {
                                    // var hexcode = [];
                                    //
                                    // if(!err)
                                    // {
                                    //     colors.forEach( function(vz, k) {
                                    //         var hexdata = rgbToHex(vz._rgb);
                                    //         hexcode.push(hexdata);
                                    //     });
                                    //     var hexList = hexcode.join(',');
                                    //     // updateHex(hexList, vl.id);
                                    //     fileDetails.hexCode = hexList;
                                    // }
                                    // else
                                            fileDetails.hexCode = '';

                                        // Exif('uploads/'+uploadedFolder+'/'+vl.name, function(error, metadata) {

                                            fileDetails.cloudFilePath = '';
                                            fileDetails.imgWidth = info.width;
                                            fileDetails.imgHeight = info.height;
                                            fileDetails.rotation = '';
                                            fileDetails.poster = '';
                                            fileDetails.oname = vl.oname;
                                            pArray.push(fileDetails);

                                            // if(tot == (fileCompressPath.length - 1))
                                            {
                                                allFiles.filePaths = fNames;
                                                allFiles.details =  pArray.reverse();
                                                // res.json(allFiles);
                                                resolve(allFiles);
                                            }
                                            tot++;
                                        // })
                                    // });
                                });
                            }
                            else {
                                return image
                                .resize(metadata.width)
                                .toFile(output, function(err, info) {

                                    var fileDetails = {};
                                    fNames.push(urlsString+uploadedFolder+"/"+vk);
                                    var imgDirq = "" + __dirname;
                                    var imgDir = "" + __dirname.split(path.sep).pop();
                                    var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                    var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                    fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                    fileDetails.photId = vl.id;
                                    fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                                    fileDetails.photo_type = vl.ptype;


                                    // getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                    // var hexcode = [];
                                    //
                                    // if(!err)
                                    // {
                                    //     colors.forEach( function(vz, k) {
                                    //         var hexdata = rgbToHex(vz._rgb);
                                    //         hexcode.push(hexdata);
                                    //     });
                                    //     var hexList = hexcode.join(',');
                                    //     // updateHex(hexList, vl.id);
                                    //     fileDetails.hexCode = hexList;
                                    // }
                                    // else
                                            fileDetails.hexCode = '';

                                        // Exif('uploads/'+uploadedFolder+'/'+vl.name, function(error, metadata) {

                                            // console.log(metadata);

                                            fileDetails.cloudFilePath = '';
                                            fileDetails.imgWidth = info.width;
                                            fileDetails.imgHeight = info.height;
                                            fileDetails.rotation = '';
                                            fileDetails.poster = '';
                                            fileDetails.oname = vl.oname;
                                            pArray.push(fileDetails);

                                            // if(tot == (fileCompressPath.length - 1))
                                            {
                                                allFiles.filePaths = fNames;
                                                allFiles.details =  pArray.reverse();
                                                // res.json(allFiles);
                                                resolve(allFiles);
                                            }
                                            tot++;
                                        // })
                                    // });
                                });
                            }
                        })
                        .then(function(data) {

                        });
                    });
                }
        }
        });

        // prom.then(function(dt) {
        // return dt;
        // });

        return prom;
}

photosUpload = function(req, res, next) {
        
        // var sharp       = require('sharp');
        var cloudinary  = require('cloudinary');
        var autoRotate  = require('exif-image-auto-rotation');
        var readChunk   = require('read-chunk');
        var imageType   = require('image-type');
        logger.info('=================================API photosUpload called============================');
        cloudinary.config({
            cloud_name: 'homehapp',
            api_key: '674338823352987',
            api_secret: 'urOckACznNPsN58_1zewwJmasnI'
        });
        logger.info('Query parameters are : ');
        logger.info(req.query);
        var myFile="";
        var FilesNames = [];
        var pushFileNames = [];
        var fileCompressPath = [];
        var colorImages= [];
        var results = {};
        var photoArray = [];
        var allFiles = {};
        var homeId = req.query.hId;
        var nabId = req.query.nId;
        var pType = req.query.pType;
        var coverPhotoType = (checkEmpty(pType) ? pType : req.query.coverPhotoType);
        var coverPhotoTypeModified = (checkEmpty(pType) ? pType : req.query.coverPhotoType);
        var activeFlag = req.query.activeFlag;
        var storyId = req.query.storyId;
        var userid = req.query.userid;
        var companyid = req.query.companyid;
        var timelineids = req.query.timelineids;
        if(!checkEmpty(activeFlag) ){
           activeFlag =1;
        }
        console.log(req.query);
        var forStory = (req.query.forStory ? req.query.forStory : 0);

        var urlsString = req.hostname;
        if (req.hostname === 'localhost') {
            urlsString = urlsString + '/homehapp';
        }
        urlsString += '/uploads/';

        var folderName = (req.body.folderName)?req.body.folderName:'common';
        if (!fs.existsSync("uploads/" + folderName)) {
            fs.mkdirSync("uploads/" + folderName, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        var d   = new Date();
        var yy  = d.getFullYear();
        var mm  = d.getMonth()+1;
        var dd  = d.getDate();
        var h   = d.getHours();
        var m   = d.getMinutes();
        var uploadedFolder = "";

        var folderName = (req.body.folderName)?req.body.folderName:'common';
        uploadedFolder = folderName;

        if (!fs.existsSync("uploads/" + uploadedFolder)) {
            fs.mkdirSync(uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }

        uploadedFolder  += "/"+yy;
        if (!fs.existsSync("uploads/" +uploadedFolder)) {
            fs.mkdirSync("uploads/" +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+mm;
        if (!fs.existsSync("uploads/" + uploadedFolder)) {
            fs.mkdirSync("uploads/" +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+dd;
        if (!fs.existsSync("uploads/"  +uploadedFolder)) {
            fs.mkdirSync("uploads/"  +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+h;
        if (!fs.existsSync("uploads/"  +uploadedFolder)) {
            fs.mkdirSync("uploads/"  +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        var randomFilePath =""+ uuid.v1();
        var randomFolderName = randomFilePath.split("-").pop();
        uploadedFolder  += "/"+randomFolderName;
        if (!fs.existsSync("uploads/"  +uploadedFolder)) {
            fs.mkdirSync("uploads/"  +uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        logger.info('Folder Name : ');
        logger.info(uploadedFolder);
        logger.info(req.body);
        
        
        var storage =   multer.diskStorage({
                        destination: function (req, file, callback) {
                            logger.info('Inside Directory structure for upload');
                            logger.info(file);
                            callback(null, './uploads/'+uploadedFolder);
                        },
                        filename: function (req, file, callback) {
                                logger.info('file Info ');
                                logger.info(file.originalname);
                                if(file.mimetype.indexOf('video') !== -1) {
                                    coverPhotoType = 8;
                                }
                                else {
                                    coverPhotoType = parseInt(coverPhotoTypeModified);
                                }

                                var imgData = {};
                                
                                myFile =""+ uuid.v1()+path.extname(file.originalname);
                                var fileDetails = {};
                                FilesNames.push(urlsString+uploadedFolder+"/"+myFile);

                                var dTime = new Date().getTime();
                                var rNum = getRandomInt(1,9);
                                var num = getRandomInt(1,9);
                                var photoId = rNum+''+dTime+''+num;

                                var imgDirq = "" + __dirname;
                                var imgDir = "" + __dirname.split(path.sep).pop();
                                var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                var mainDir = imgDirq.replace(imgDir,'')+'uploads/';

                                var actualImagePath = withoutLastChunk+""+folderName+""+myFile;
                                fileDetails.filePath = (urlsString+uploadedFolder+"/"+myFile);
                                fileDetails.photId = photoId;
                                fileDetails.originalname = file.originalname;
                                
                                fileDetails.actualPath = actualImagePath;

                                imgData.name = myFile;
                                imgData.id = photoId;
                                imgData.ptype = coverPhotoType;
                                imgData.apath = mainDir+uploadedFolder;
                                imgData.originalname = file.originalname;
                                
                                fileCompressPath.push(imgData);

                                photoArray.push(fileDetails);
                                var photoPath= uploadedFolder+"/"+myFile ;

                                var sqlPhotos = "INSERT INTO tbl_photo_master SET ";
                                var sqlPhotoGen = "";

                                if(checkEmpty(photoId)){
                                    sqlPhotoGen += " photo_id = "+ photoId +", ";
                                }
                                if(checkEmpty(nabId)){
                                    sqlPhotoGen += " hood_id = "+ nabId +", ";
                                }
                                 if(checkEmpty(homeId)){
                                    sqlPhotoGen += " home_id = "+ homeId +", ";
                                }
                                 if(checkEmpty(companyid)){
                                    sqlPhotoGen += " company_id = "+ companyid +", ";
                                }
                                if(checkEmpty(coverPhotoType)){
                                    if(isNaN(coverPhotoType)){
                                        coverPhotoType = 5;
                                    }
                                    sqlPhotoGen += " cover_photo = "+ coverPhotoType +", ";
                                }
                                if(checkEmpty(activeFlag)){
                                    sqlPhotoGen += " active_flag = "+ activeFlag +", ";
                                }
                                if(checkEmpty(storyId)){
                                   sqlPhotoGen += " story_id = "+ storyId +", ";
                                }
                                 if(checkEmpty(userid)){
                                   sqlPhotoGen += " userid = "+ userid +", ";
                                }
                                if(checkEmpty(pType)){
                                   sqlPhotoGen += " photo_type = "+ pType +", ";
                                }
                                if(checkEmpty(photoPath)){
                                   sqlPhotoGen += " photo_path = '"+ photoPath +"', ";
                                }
                                 if(checkEmpty(timelineids)){
                                   sqlPhotoGen += " timeline_id = "+ timelineids +", ";
                                }

                                sqlPhotoGen += "createdon = now() ";
                                sqlPhotos = sqlPhotos +" " +sqlPhotoGen+"ON DUPLICATE KEY UPDATE "+ sqlPhotoGen+" ";
                                db.query(sqlPhotos, function (err, result) {
                                    logger.info(sqlPhotos);
                                    logger.info(err);
                                    if (err) {
                                     
                                       // console.log(sqlPhotos);
                                       // console.log(err);
//                                    throw err;
                                    }
                                    if(checkEmpty(storyId)){
                                        if(coverPhotoType == 1 ||  coverPhotoType === '1' || forStory == 1 || forStory === '1') {
                                            var sqlStory = "INSERT INTO tbl_story_master SET story_id = "+ storyId +" ON DUPLICATE KEY UPDATE story_id = "+ storyId +"";
                                            db.query(sqlStory, function (err, result) {
                                                logger.info(sqlPhotos);
                                                logger.info(err);
                                                  if (err) {
                                                    //console.log(sqlStory);
                                                    //console.log(err);
                                                    throw err;
                                                  }
                                            });
                                        }
                                    }
                                    if(checkEmpty(userid)) {
                                        if(coverPhotoType == 6 ||  coverPhotoType === '6'){
                                            var sQuery = 'UPDATE \n\
                                                                tbl_photo_master \n\
                                                            SET \n\
                                                                active_flag = 0 \n\
                                                            WHERE \n\
                                                                userid = ' + userid + '\n\
                                                            AND \n\
                                                                cover_photo = 6 \n\
                                                            AND \n\
                                                                photo_id <> "' + photoId + '"';
                                            db.query(sQuery, function(err, rows, fields) {
                                                    logger.info(sqlPhotos);
                                                logger.info(err);
                                                   if(err){
                                                    //console.log(sQuery);
                                                    //console.log(err);

                                                   }
                                            });
                                        }
                                    }

                                    if(checkEmpty(homeId)) {
                                        if(coverPhotoType == 1 ||  coverPhotoType === '1'){
                                            
                                            var sQuery = 'UPDATE \n\
                                                                tbl_photo_master \n\
                                                            SET \n\
                                                                active_flag = 0 \n\
                                                            WHERE \n\
                                                                home_id = ' + homeId + '\n\
                                                            AND \n\
                                                                cover_photo = 1 \n\
                                                            AND \n\
                                                                photo_id <> "' + photoId + '"';
                                            db.query(sQuery, function(err, rows, fields) {
                                                    logger.info(sqlPhotos);
                                                    logger.info(err);
                                                   if(err){
                                                       //console.log(sQuery);
                                                       // console.log(err);

                                                   }
                                            });
                                        }
                                    }

                                    if(checkEmpty(storyId)) {
                                        if(coverPhotoType == 1 ||  coverPhotoType === '1'){
                                            var sQuery = 'UPDATE \n\
                                                                tbl_photo_master \n\
                                                            SET \n\
                                                                active_flag = 0 \n\
                                                            WHERE \n\
                                                                story_id = ' + storyId + '\n\
                                                            AND \n\
                                                                cover_photo = 1 \n\
                                                            AND \n\
                                                                photo_id <> "' + photoId + '"';
                                            db.query(sQuery, function(err, rows, fields) {
                                                    logger.info(sqlPhotos);
                                                    logger.info(err);
                                                   if(err){
                                                        //console.log(sQuery);
                                                        //console.log(err);

                                                   }
                                            });
                                        }
                                    }
                                });
                                callback(null, myFile);
                        }

        });
        var maxSize = 1000*1000*1000*1000;
        var upload = multer({ storage : storage, limits: { fileSize: maxSize } }).array('userPhoto',200);

        var tot = 0;
        upload(req,res,function(err) {

            if(err) {
                return res.end("Error uploading file.");
            }

            var getColors   = require("get-image-colors");
//        var exif        = require('exiftool');
//        var fs          = require('fs');
            var ffmetadata  = require("ffmetadata");
            var thumbler    = require('video-thumb');
            var Exif = require("simple-exiftool");

            // var Mp4Convert = require("mp4-convert");

            var fNames = [];
            var pArray = [];
            fileCompressPath.forEach(function(vl, i) {
                logger.info('Insile file each loop');
                logger.info(i);
                logger.info(vl);
                if(vl.ptype == 8) {

                    var fileDetails = {};
                    fNames.push(urlsString+uploadedFolder+"/"+vl.name);
                    var imgDirq = "" + __dirname;
                    var imgDir = "" + __dirname.split(path.sep).pop();
                    var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                    var name = vl.name.split('.');

                    var fconvertedPath = (urlsString+uploadedFolder+"/"+vl.name);
                    var actualImagePath = withoutLastChunk+""+folderName+""+vl.name;
                    var brkname = vl.name.split('.');
                    brkname.pop();
                    // console.log(brkname);
                    var screenShotName = brkname.join('.') + '.png';
                    // console.log(screenShotName);

                    // Exif('uploads/'+uploadedFolder+'/'+vl.name, function(error, metadata) {
                    //
                    // console.log(metadata);
                    // console.log(error);
                    //
                    //
                    // if(metadata.Rotation == 90)
                    // {
                    //     var vht = metadata.ImageWidth;
                    //     var vwt = metadata.ImageHeight;
                    // }
                    // else {
                    //     var vht = metadata.ImageHeight;
                    //     var vwt = metadata.ImageWidth;
                    // }
                    // thumbler.extract('uploads/'+uploadedFolder+'/'+vl.name, 'uploads/'+uploadedFolder+'/' + screenShotName, '00:00:01', vwt+'x'+vht, function() {
                    //
                    //     var fileName = screenShotName.split('.');
                    //     fileName[fileName.length-2] = fileName[fileName.length-2]+'_optimized';
                    //     var screenShotNameConverted = fileName.join('.');
                    //     var output = 'uploads/'+uploadedFolder+'/'+screenShotNameConverted;
                    //
                    //     console.log(output);
                    //
                    //     var image = sharp('uploads/'+uploadedFolder+'/' + screenShotName);
                    //     image
                    //         .metadata()
                    //         .then(function(metadata) {
                    //             console.log(metadata.width);
                    //             if(metadata.width>1920) {
                    //
                    //                 var nw = 1920;
                    //                 return image
                    //                 .resize(nw)
                    //                 .toFile(output, function(err, info) {
                    //
                    //                     cloudinary.uploader.upload(output, function(result) {
                    //
                    //                         var upsql = "UPDATE tbl_photo_master SET video_thumbnail = \""+result.url+"\" WHERE photo_id = "+vl.id;
                    //
                    //                         console.log(result.url);
                    //
                    //                         db.query(upsql, function (err, req) {
                    //                             if(req) {
                    //                                 fileDetails.filePath = urlsString+uploadedFolder+"/"+vl.name;
                    //                                 fileDetails.poster = result.url;
                    //                                 fileDetails.photId = vl.id;
                    //                                 fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                    //                                 fileDetails.photo_type = vl.ptype;
                    //                                 fileDetails.hexCode = '';
                    //                                 fileDetails.cloudFilePath = '';
                    //                                 fileDetails.imgWidth = '';
                    //                                 fileDetails.imgHeight = '';
                    //                                 fileDetails.rotation = '';
                    //                                 pArray.push(fileDetails);
                    //                                 if(tot == (fileCompressPath.length - 1))
                    //                                 {
                    //                                     allFiles.filePaths = fNames;
                    //                                     allFiles.details =  pArray.reverse();
                    //                                     res.json(allFiles);
                    //                                 }
                    //                                 tot++;
                    //                             }
                    //                         });
                    //
                    //                     },
                    //                     {
                    //                         timeout: 100000000000
                    //                     });
                    //                 });
                    //             }
                    //             else {
                    //                 return image
                    //                 .resize(metadata.width)
                    //                 .toFile(output, function(err, info) {
                    //                     cloudinary.uploader.upload(output, function(result) {
                    //
                    //                         var upsql = "UPDATE tbl_photo_master SET video_thumbnail = \""+result.url+"\" WHERE photo_id = "+vl.id;
                    //
                    //                         db.query(upsql, function (err, req) {
                    //                             if(req) {
                    //
                    //                                 fileDetails.filePath = urlsString+uploadedFolder+"/"+vl.name;
                    //                                 fileDetails.poster = result.url;
                    //                                 fileDetails.photId = vl.id;
                    //                                 fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                    //                                 fileDetails.photo_type = vl.ptype;
                    //                                 fileDetails.hexCode = '';
                    //                                 fileDetails.cloudFilePath = '';
                    //                                 fileDetails.imgWidth = '';
                    //                                 fileDetails.imgHeight = '';
                    //                                 fileDetails.rotation = '';
                    //                                 pArray.push(fileDetails);
                    //                                 if(tot == (fileCompressPath.length - 1))
                    //                                 {
                    //                                     allFiles.filePaths = fNames;
                    //                                     allFiles.details =  pArray.reverse();
                    //                                     res.json(allFiles);
                    //                                 }
                    //                                 tot++;
                    //                             }
                    //                         });
                    //
                    //                     },
                    //                     {
                    //                         timeout: 100000000000
                    //                     });
                    //                 });
                    //             }
                    //         });
                    // });
                    // });

                    fileDetails.filePath = urlsString+uploadedFolder+"/"+vl.name;
                    fileDetails.poster = urlsString+uploadedFolder+"/"+name[0]+'.png';
                    fileDetails.photId = vl.id;
                    fileDetails.actualPath = uploadedFolder+"/"+vl.name;
                    fileDetails.photo_type = vl.ptype;
                    fileDetails.hexCode = '';
                    fileDetails.cloudFilePath = '';
                    fileDetails.imgWidth = '';
                    fileDetails.imgHeight = '';
                    fileDetails.rotation = '';
                    fileDetails.poster = '';
                    fileDetails.originalname = vl.originalname;
                    pArray.push(fileDetails);
                    if(tot == (fileCompressPath.length - 1))
                    {
                        allFiles.filePaths = fNames;
                        allFiles.details =  pArray.reverse();
                        res.json(allFiles);
                    }
                    tot++;
                }
                else {

                    var buffer = readChunk.sync('uploads/'+uploadedFolder+'/'+vl.name, 0, 12);
                    var imageBuff = imageType(buffer);

                    vl.newName = vl.name;

                    if(imageBuff) {
                        if(imageBuff.ext) {
                            var ppth = vl.name.split('.');
                            var oImgExt = ppth[ppth.length-1];
                            ppth[ppth.length-1] = imageBuff.ext;
                            vl.newName = ppth.join('.');
                        }
                    }


                    var fileName = vl.name.split('.');
                    fileName[fileName.length-2] = fileName[fileName.length-2]+'_optimized';
                    var vk = fileName.join('.');
                    var output = 'uploads/'+uploadedFolder+'/'+vk;

                    var autoRotateAllow = true;

                    if(vl.newName.indexOf(".jpg") == -1 || vl.newName.indexOf(".JPG") == -1 || vl.newName.indexOf(".jpeg") == -1 || vl.newName.indexOf(".JPEG") == -1) {
                        autoRotateAllow = false;
                    }

                    if(vl.name.indexOf(".pdf") != -1 || vl.name.indexOf(".PDF") != -1)
                    {   
                        cloudinary.uploader.upload('uploads/'+uploadedFolder+'/'+vl.name, function(result) {
                            var cloudURL = result.url;
                            if(serverCounter ==6){
                                serverCounter =1;
                            }
                            if(cloudURL.match('^http://')){
                                serverResUrl = "https://res-"+serverCounter;
                                cloudURL = cloudURL.replace("http://res",serverResUrl);
                            } 
                            var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", height = "+result.height+", width = "+result.width+" WHERE photo_id = "+vl.id;
                            serverCounter= serverCounter+1;
                            db.query(upsql, function (err, req) {
                                logger.info(upsql);
                                logger.info(err);
                                if(err){
                                   // console.log(upsql);
                                    //console.log(err);
                                }
                                if(req) {

                                    var fileDetails = {};
                                    var actualImagePath = withoutLastChunk+""+folderName+""+vl.name;
                                    fNames.push(urlsString+uploadedFolder+"/"+vl.name);
                                    fileDetails.filePath = (urlsString+uploadedFolder+"/"+vl.name);
                                    fileDetails.photId = vl.id;
                                    fileDetails.actualPath = actualImagePath;
                                    fileDetails.photo_type = vl.ptype;
                                    fileDetails.hexCode = '';

                                    fileDetails.cloudFilePath = cloudURL;
                                    fileDetails.imgWidth = '';
                                    fileDetails.imgHeight = '';
                                    fileDetails.rotation = '';
                                    fileDetails.poster = '';
                                    fileDetails.originalname = vl.originalname;
                                    pArray.push(fileDetails);

                                    if(tot == (fileCompressPath.length - 1))
                                    {
                                        allFiles.filePaths = fNames;
                                        allFiles.details =  pArray.reverse();
                                        res.json(allFiles);
                                    }
                                    tot++;
                                }
                            });

                        },
                        {
                            timeout: 100000000000
                        });
                    }
                    else if(!autoRotateAllow) {

                        var image = sharp('uploads/'+uploadedFolder+'/'+vl.name);
                        image
                            .metadata()
                            .then(function(metadata) {

                                if(metadata.width>1920) {

                                    var nw = 1920;
                                    return image
                                    .resize(nw)
                                    .toFile(output, function(err, info) {
                                        
                                        var fileDetails = {};
                                        fNames.push(urlsString+uploadedFolder+"/"+vk);
                                        var imgDirq = "" + __dirname;
                                        var imgDir = "" + __dirname.split(path.sep).pop();
                                        var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                        var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                        fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                        fileDetails.photId = vl.id;
                                        fileDetails.actualPath = actualImagePath;
                                        fileDetails.photo_type = vl.ptype;
                                        fileDetails.originalname = vl.originalname;


                                        getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                            var hexcode = [];

                                            if(!err)
                                            {
                                                colors.forEach( function(vz, k) {
                                                    var hexdata = rgbToHex(vz._rgb);
                                                    hexcode.push(hexdata);
                                                });
                                                var hexList = hexcode.join(',');
                                                updateHex(hexList, vl.id);
                                                fileDetails.hexCode = hexList;
                                            }
                                            else
                                                fileDetails.hexCode = '';
                                            
                                            cloudinary.uploader.upload('uploads/'+uploadedFolder+'/'+vk, function(result) {
                                                var cloudURL = result.url;
                                                if(serverCounter ==6){
                                                    serverCounter =1;
                                                }
                                                if(cloudURL.match('^http://')){
                                                    serverResUrl = "https://res-"+serverCounter;
                                                    cloudURL = cloudURL.replace("http://res",serverResUrl);
                                                } 
                                                var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = "+result.width+", height = "+result.height+" WHERE photo_id = "+vl.id;
                                                serverCounter= serverCounter+1;
                                                db.query(upsql, function (err, req) {
                                                    if(err){
                                                        //console.log(upsql);
                                                       // console.log(err);
                                                    }
                                                    if(req) {
                                                        fileDetails.cloudFilePath = cloudURL;
                                                        fileDetails.imgWidth = '';
                                                        fileDetails.imgHeight = '';
                                                        fileDetails.rotation = '';
                                                        fileDetails.poster = '';
                                                        pArray.push(fileDetails);

                                                        if(tot == (fileCompressPath.length - 1))
                                                        {
                                                            allFiles.filePaths = fNames;
                                                            allFiles.details =  pArray.reverse();
                                                            res.json(allFiles);
                                                        }
                                                        tot++;
                                                    }
                                                });

                                            },
                                            {
                                                timeout: 100000000000
                                            });
                                        });
                                    });
                                }
                                else {
                                    return image
                                    .resize(metadata.width)
                                    .toFile(output, function(err, info) {

                                        var fileDetails = {};
                                        fNames.push(urlsString+uploadedFolder+"/"+vk);
                                        var imgDirq = "" + __dirname;
                                        var imgDir = "" + __dirname.split(path.sep).pop();
                                        var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                        var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                        fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                        fileDetails.photId = vl.id;
                                        fileDetails.actualPath = actualImagePath;
                                        fileDetails.photo_type = vl.ptype;


                                        getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                            var hexcode = [];

                                            if(!err)
                                            {
                                                colors.forEach( function(vz, k) {
                                                    var hexdata = rgbToHex(vz._rgb);
                                                    hexcode.push(hexdata);
                                                });
                                                var hexList = hexcode.join(',');
                                                updateHex(hexList, vl.id);
                                                fileDetails.hexCode = hexList;
                                            }
                                            else
                                                fileDetails.hexCode = '';
                                            
                                            cloudinary.uploader.upload('uploads/'+uploadedFolder+'/'+vk, function(result) {
                                                var cloudURL = result.url;
                                                if(serverCounter ==6){
                                                    serverCounter =1;
                                                }
                                                if(cloudURL.match('^http://')){
                                                    serverResUrl = "https://res-"+serverCounter;
                                                    cloudURL = cloudURL.replace("http://res",serverResUrl);
                                                } 
                                                var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = \""+result.width+"\", height = \""+result.height+"\" WHERE photo_id = "+vl.id;
                                                console.log(result);
                                                serverCounter= serverCounter+1;
                                                db.query(upsql, function (err, req) {
                                                    logger.info(upsql);
                                                    logger.info(err);
                                                    if(err){
                                                       // console.log(upsql);
                                                       // console.log(err);
                                                    }
                                                    if(req) {

                                                        fileDetails.cloudFilePath = cloudURL;
                                                        fileDetails.imgWidth = '';
                                                        fileDetails.imgHeight = '';
                                                        fileDetails.rotation = '';
                                                        fileDetails.poster = '';
                                                        
                                                        pArray.push(fileDetails);

                                                        if(tot == (fileCompressPath.length - 1))
                                                        {
                                                            allFiles.filePaths = fNames;
                                                            allFiles.details =  pArray.reverse();
                                                            res.json(allFiles);
                                                        }
                                                        tot++;

                                                    }
                                                });
                                            },
                                            {
                                                timeout: 100000000000
                                            });
                                        });
                                    });
                                }
                            })
                            .then(function(data) {

                            });
                    }
                    else {
                        autoRotate( 'uploads/'+uploadedFolder+'/'+vl.name, function() {

                            var image = sharp('uploads/'+uploadedFolder+'/'+vl.name);
                            image
                                .metadata()
                                .then(function(metadata) {
                                    if(metadata.width>1920) {

                                        var nw = 1920;
                                        return image
                                        .resize(nw)
                                        .toFile(output, function(err, info) {

                                            var fileDetails = {};
                                            fNames.push(urlsString+uploadedFolder+"/"+vk);
                                            var imgDirq = "" + __dirname;
                                            var imgDir = "" + __dirname.split(path.sep).pop();
                                            var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                            var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                            fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                            fileDetails.photId = vl.id;
                                            fileDetails.actualPath = actualImagePath;
                                            fileDetails.photo_type = vl.ptype;
                                            fileDetails.originalname = vl.originalname;

                                            getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                                var hexcode = [];

                                                if(!err)
                                                {
                                                    colors.forEach( function(vz, k) {
                                                        var hexdata = rgbToHex(vz._rgb);
                                                        hexcode.push(hexdata);
                                                    });
                                                    var hexList = hexcode.join(',');
                                                    updateHex(hexList, vl.id);
                                                    fileDetails.hexCode = hexList;
                                                }
                                                else
                                                    fileDetails.hexCode = '';
                                                
                                                
                                                cloudinary.uploader.upload('uploads/'+uploadedFolder+'/'+vk, function(result) {
                                                    var cloudURL =result.url;
                                                    
                                                    if(serverCounter ==6){
                                                        serverCounter =1;
                                                    }
                                                    if(cloudURL.match('^http://')){
                                                        serverResUrl = "https://res-"+serverCounter;
                                                        cloudURL = cloudURL.replace("http://res",serverResUrl);
                                                    } 
                                                    var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = \""+result.width+"\", height = \""+result.height+"\" WHERE photo_id = "+vl.id;
                                                    console.log(result);
                                                    serverCounter= serverCounter+1;
                                                    db.query(upsql, function (err, req) {
                                                        logger.info(upsql);
                                                        logger.info(err);
                                                        if(err){
                                                            //console.log(upsql);
                                                            //console.log(err);
                                                        }
                                                        if(req) {
                                                            fileDetails.cloudFilePath = cloudURL;
                                                            fileDetails.imgWidth = '';
                                                            fileDetails.imgHeight = '';
                                                            fileDetails.rotation = '';
                                                            fileDetails.poster = '';
                                                            pArray.push(fileDetails);

                                                            if(tot == (fileCompressPath.length - 1))
                                                            {
                                                                allFiles.filePaths = fNames;
                                                                allFiles.details =  pArray.reverse();
                                                                res.json(allFiles);
                                                            }
                                                            tot++;
                                                        }
                                                    });

                                                },
                                                {
                                                    timeout: 100000000000
                                                });
                                            });
                                        });
                                    }
                                    else {
                                        return image
                                        .resize(metadata.width)
                                        .toFile(output, function(err, info) {

                                            var fileDetails = {};
                                            fNames.push(urlsString+uploadedFolder+"/"+vk);
                                            var imgDirq = "" + __dirname;
                                            var imgDir = "" + __dirname.split(path.sep).pop();
                                            var withoutLastChunk = imgDirq.slice(0, imgDirq.lastIndexOf("\\"));

                                            var actualImagePath = withoutLastChunk+""+folderName+""+vk;
                                            fileDetails.filePath = (urlsString+uploadedFolder+"/"+vk);
                                            fileDetails.photId = vl.id;
                                            fileDetails.actualPath = actualImagePath;
                                            fileDetails.photo_type = vl.ptype;
                                            fileDetails.originalname = vl.originalname;


                                            getColors('uploads/'+uploadedFolder+'/'+vk, function(err, colors){
                                                var hexcode = [];

                                                if(!err)
                                                {
                                                    colors.forEach( function(vz, k) {
                                                        var hexdata = rgbToHex(vz._rgb);
                                                        hexcode.push(hexdata);
                                                    });
                                                    var hexList = hexcode.join(',');
                                                    updateHex(hexList, vl.id);
                                                    fileDetails.hexCode = hexList;
                                                }
                                                else
                                                    fileDetails.hexCode = '';
                                                
                                                
                                                cloudinary.uploader.upload('uploads/'+uploadedFolder+'/'+vk, function(result) {
                                                    var cloudURL = result.url;
                                                    if(serverCounter ==6){
                                                        serverCounter =1;
                                                    }
                                                    if(cloudURL.match('^http://')){
                                                        serverResUrl = "https://res-"+serverCounter;
                                                        cloudURL = cloudURL.replace("http://res",serverResUrl);
                                                    } 
                                                    var upsql = "UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\", width = "+result.width+", height = "+result.height+" WHERE photo_id = "+vl.id;//"UPDATE tbl_photo_master SET cloud_path = \""+cloudURL+"\" WHERE photo_id = "+vl.id;
                                                    console.log(result);
                                                    serverCounter= serverCounter+1;
                                                    db.query(upsql, function (err, req) {
                                                        logger.info(upsql);
                                                        logger.info(err);
                                                        
                                                        if(err){
                                                            //console.log(upsql);
                                                            //console.log(err);
                                                        }
                                                        if(req) {

                                                            fileDetails.cloudFilePath = cloudURL;
                                                            fileDetails.imgWidth = '';
                                                            fileDetails.imgHeight = '';
                                                            fileDetails.rotation = '';
                                                            fileDetails.poster = '';
                                                            pArray.push(fileDetails);

                                                            if(tot == (fileCompressPath.length - 1))
                                                            {
                                                                allFiles.filePaths = fNames;
                                                                allFiles.details =  pArray.reverse();
                                                                res.json(allFiles);
                                                            }
                                                            tot++;
                                                        }
                                                    });
                                                },
                                                {
                                                    timeout: 100000000000
                                                });
                                            });
                                        });
                                    }
                                })
                                .then(function(data) {

                                });
                            });
                        }
                }
            });
        });
};

var getPhotoByIds = function(req, res, next){



    var urlsString = 'http://'+req.hostname;
    var defaultImg= 'http://'+req.hostname+'/tools/img/homeIcons/132.svg';
    if(req.hostname === 'localhost'){
        urlsString = urlsString + '/homehapp';
        defaultImg = 'http://'+req.hostname+':8080/homehapp/tools/img/homeIcons/132.svg';
    }
    if(req.hostname === '192.168.2.69'){
        urlsString = urlsString + ':8080/homehapp';
        defaultImg = 'http://'+req.hostname+':8080/homehapp/tools/img/homeIcons/132.svg';
    }
    urlsString += '/uploads/';
    var parameters = req.query;
    var photo_id = parameters.photoIds;
    
    var version = req.query.version; 
    
    if(version == 1.1) {
         var sqlUser = " SELECT \n\
                                photo_id,\n\
                                cover_photo, \n\
                                concat('"+urlsString+"',photo_path) AS photoPath,\n\
                                color_codes, \n\
                                createdon \n\
                        FROM \n\
                            tbl_photo_master \n\
                        WHERE \n\
                                photo_id IN ("+ photo_id +")\n\
                            AND\n\
                                active_flag=1";


        var retArr = {};
        var error = {};

        db.query(sqlUser,function (err, rows, fields){
                var results = [];

                if(err){
                    error.errorCode = 1;
                    error.errorMsg = 'No Records found';
                    retArr.results = [];
                    retArr.error = error;
                    res.json(retArr);
                    throw err;
                    return 1;
                }else{
                    if(rows){
                        if(rows.length > 0){
                        rows.forEach(function(vl , i){
                            var data ={};
                            if(parseInt(vl.cover_photo) != 8)
                            {
                                var ppth = vl.photoPath.split('.');
                                ppth[ppth.length-2] = ppth[ppth.length-2]+'_optimized';
                                vl.photoPath = ppth.join('.');
                            }
                            data['pId']         =   ""+vl.photo_id;
                            data['pPath']       =   (vl.photoPath ? vl.photoPath : defaultImg);
                            data['pType']       =   vl.cover_photo;
                            data['cc']          =   (vl.color_codes ?  vl.color_codes: '');
                            data['cc1']         =   (vl.color_codes ?  vl.color_codes.slice(0, vl.color_codes.indexOf(',')) : '#FFFFFF');
                            results.push(data);
                        });

                        error.errorCode = 0;
                        error.errorMsg = 'Data Fetched Successfully';
                        retArr.results = results;
                        retArr.error = error;
                        res.json(retArr);
                    }else{
                         error.errorCode = 1;
                        error.errorMsg = 'No records found';
                        retArr.results = [];
                        retArr.error = error;
                        res.json(retArr);
                    }

                    }else{
                        error.errorCode = 1;
                        error.errorMsg = 'No records found';
                        retArr.results = [];
                        retArr.error = error;
                        res.json(retArr);
                    }
                }

        });
    }else{
         var sqlUser = " SELECT \n\
                                photo_id,\n\
                                cover_photo, \n\
                                concat('"+urlsString+"',photo_path) AS photoPath,\n\
                                color_codes, \n\
                                createdon \n\
                        FROM \n\
                            tbl_photo_master \n\
                        WHERE \n\
                                photo_id IN ("+ photo_id +")\n\
                            AND\n\
                                active_flag=1";


        var retArr = {};
        var error = {};

        db.query(sqlUser,function (err, rows, fields){
                var results = [];

                if(err){
                    error.errorCode = 1;
                    error.errorMsg = 'No Records found';
                    retArr.results = [];
                    retArr.error = error;
                    res.json(retArr);
                    throw err;
                    return 1;
                }else{
                    if(rows){
                        if(rows.length > 0){
                        rows.forEach(function(vl , i){
                            var data ={};
                            if(parseInt(vl.cover_photo) != 8)
                            {
                                var ppth = vl.photoPath.split('.');
                                ppth[ppth.length-2] = ppth[ppth.length-2]+'_optimized';
                                vl.photoPath = ppth.join('.');
                            }
                            data['pId']         =   ""+vl.photo_id;
                            data['pPath']       =   (vl.photoPath ? vl.photoPath : defaultImg);
                            data['pType']       =   vl.cover_photo;
                            data['cc']          =   (vl.color_codes ?  vl.color_codes: '');
                            data['cc1']         =   (vl.color_codes ?  vl.color_codes.slice(0, vl.color_codes.indexOf(',')) : '#FFFFFF');
                            results.push(data);
                        });

                        error.errorCode = 0;
                        error.errorMsg = 'Data Fetched Successfully';
                        retArr.results = results;
                        retArr.error = error;
                        res.json(retArr);
                    }else{
                         error.errorCode = 1;
                        error.errorMsg = 'No records found';
                        retArr.results = [];
                        retArr.error = error;
                        res.json(retArr);
                    }

                    }else{
                        error.errorCode = 1;
                        error.errorMsg = 'No records found';
                        retArr.results = [];
                        retArr.error = error;
                        res.json(retArr);
                    }
                }

        });
    }
    
   

};



var folders = function(req, res, next){

        var d   = new Date();

        var yy  = d.getFullYear();

        var mm  = d.getMonth()+1;

        var dd  = d.getDate();

        var h   = d.getHours();

        var m   = d.getMinutes();
        var uploadedFolder = "";

      //  urlsString= urlsString+":"+"3000/"+"static/";
        var folderName = (req.body.folderName)?req.body.folderName:'common';
        uploadedFolder ="uploads/" + folderName;

        if (!fs.existsSync(uploadedFolder)) {
            fs.mkdirSync(uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+yy;
        if (!fs.existsSync(uploadedFolder)) {
            fs.mkdirSync(uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+mm;
        if (!fs.existsSync(uploadedFolder)) {
            fs.mkdirSync(uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }
        uploadedFolder  += "/"+dd;
        if (!fs.existsSync(uploadedFolder)) {
            fs.mkdirSync(uploadedFolder, 0777, function (err,callback) {
                if (err) {
                    callback('folder created');
                }
            });
        }


        res.set(1);
    return 1;
};

module.exports = {
  imageUpload: imageUpload,
  addImageFormPost:addImageFormPost,
  fileUploadMutlerTest:fileUploadMutlerTest,
  photosUpload:photosUpload,
  photosUpload2:photosUpload2,
  photosUploadNew:photosUploadNew,
  timelinePhotoUpload: timelinePhotoUpload,
  getPhotoByIds:getPhotoByIds,
  moveToCloud:moveToCloud,
  moveVideosToCloud: moveVideosToCloud,
  fetchCloudLink: fetchCloudLink,
  uploadVideoQueue: uploadVideoQueue,
  uploadVideoQueuePush: uploadVideoQueuePush,
  deleteFromCloud: deleteFromCloud,
  folders:folders,
};
